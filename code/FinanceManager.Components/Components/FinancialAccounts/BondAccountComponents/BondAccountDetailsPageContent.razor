@using FinanceManager.Components.Components.FinancialAccounts.Shared
@using FinanceManager.Components.Components.SharedComponents.Charts
@using FinanceManager.Domain.Entities.MoneyFlowModels;
@using FinanceManager.Domain.Entities.Bonds;

@if (Account is not null && Account.Entries is not null && (IsLoading || Account.Entries.Any()))
{
    <AccountDetailsPageContent AccountName="@Account.Name"         ChartData="ChartData"              IsLoading="@IsLoading"
                               IsLoadingMore="@_isLoadingMore"                  LoadedAllData="@_loadedAllData"                      OnLoadMore="LoadMore">
        <ActionButtons>
            <MudButton Variant="Variant.Text" Class="col-12" href="@($"Import/{Account.AccountId}")" Disabled>Import
            </MudButton>
            <MudButton Variant="Variant.Text" Class="col-12" Disabled>Export</MudButton>
            <MudButton Variant="Variant.Text" Class="col-12" href="@($"ManageAccount/{Account.AccountId}")">Manage
            </MudButton>
        </ActionButtons>
        <AddEntryOverlay>
            <MudFab Color="MudBlazor.Color.Primary" StartIcon="@Icons.Material.Filled.Add" Label="Add"       OnClick=ShowOverlay
                    Style="margin-left: 30px; position: fixed; bottom: 3vh; z-index:2;" />

            <MudOverlay Visible="@_addEntryVisibility" DarkBackground="true">
                <MudPaper Class="p-5">
                    <AddBondEntry BondAccount=Account ActionCompleted="HideOverlay" />
                </MudPaper>
            </MudOverlay>
        </AddEntryOverlay>
        <EntryFilter>
            <ValueChangeRangeFilterBar From="_filterFrom" To="_filterTo" OnFilterChanged="OnFilterChanged" />
        </EntryFilter>
        <Entries>
            @{
                var filteredEntries = GetFilteredEntries();
            }
            @if (HasActiveFilter && !filteredEntries.Any())
            {
                <MudAlert Severity="Severity.Info" Class="my-3">No entries match the current filter.</MudAlert>
            }
            else
            {
                @foreach (var entry in filteredEntries)
                {
                    var bond = _bondDetails.FirstOrDefault(x => x.Id == entry.BondDetailsId);
                    <BondAccountDetailsRow BondAccountEntry="@entry" BondAccount=Account BondDetails="bond" />
                }
            }
        </Entries>
        <SidePanel>
            <MudPaper Class="pa-3" Elevation="0" Style="background-color:transparent">
                <MudStack>
                    @if (_balanceChange.HasValue)
                    {
                        <AccountBalanceChangePanel BalanceChange="@_balanceChange.Value" Currency="@_currency" />
                    }

                    @if (_top5 is not null && _top5.Any())
                    {
                        <AccountTopBottomList Title="Top 5"                         Items="_top5 ?? []"                                             ValueColor="Color.Success"
                                              ItemTitle="@(item => _bondDetails.FirstOrDefault(x => x.Id == item.Item1.BondDetailsId)?.Name ?? "Bond")"
                                              ItemValue="@(item => $"{item.Item2} {_currency}")"
                                              ItemDate="@(item => item.Item1.PostingDate.ToString("yyyy-MM-dd"))" />
                    }

                    @if (_bottom5 is not null && _bottom5.Any())
                    {
                        <AccountTopBottomList Title="Bottom 5"                          Items="_bottom5 ?? []"                  ValueColor="Color.Error"
                                              ItemTitle="@(item => _bondDetails.FirstOrDefault(x => x.Id == item.Item1.BondDetailsId)?.Name ?? "Bond")"
                                              ItemValue="@(item => $"{item.Item2} {_currency}")"
                                              ItemDate="@(item => item.Item1.PostingDate.ToString("yyyy-MM-dd"))" />
                    }
                </MudStack>
            </MudPaper>
        </SidePanel>
    </AccountDetailsPageContent>
}
else if (Account is not null && (Account.Entries is null || !Account.Entries.Any()))
{
    <AddBondEntry BondAccount=Account ActionCompleted="HideOverlay">
        <CustomButton>
            <MudButton Variant="Variant.Text" Color="MudBlazor.Color.Primary" href="@($"Import/{Account.AccountId}")">
                Import</MudButton>
            </CustomButton>
        </AddBondEntry>
        <MudButton Variant="Variant.Text" Color="MudBlazor.Color.Primary" href="@($"Import/{Account.AccountId}")">
            Import
        </MudButton>
    }
else if (!string.IsNullOrEmpty(ErrorMessage))
    {
        <MudAlert Severity="Severity.Error">@ErrorMessage</MudAlert>
    }