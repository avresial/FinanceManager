@page "/Admin/Users"
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Roles = "Admin")]
@layout AdminLayout

<MudStack Spacing="2">
    @foreach (var message in _errors)
    {
        <MudAlert Severity="Severity.Error">@message</MudAlert>
    }
</MudStack>

<MudStack Row AlignItems="AlignItems.Center" Spacing="2" Class="mt-2">
    <MudTextField T="string" Value="@_searchText" ValueChanged="OnSearchChanged" Placeholder="Search by name"
                  Immediate="true" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" Clearable="true"
                  Class="flex-grow-1" />
    <MudIconButton Icon="@Icons.Material.Filled.Add" aria-label="add" Href="Admin/AddUser" Color="Color.Primary" />
</MudStack>
<MudTable @ref="@Table" Items="@_pagedElements" RowsPerPage="@_recordsPerPage" Dense Breakpoint="Breakpoint.Md"
          LoadingProgressColor="Color.Info" Elevation="0" Class="my-3">
    <HeaderContent>
        <MudTh>User id</MudTh>
        <MudTh>User name</MudTh>
        <MudTh>Pricing Level</MudTh>
        <MudTh>Capacity</MudTh>
        <MudTh>Action</MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd DataLabel="User id">@context.UserId</MudTd>
        <MudTd DataLabel="User name">@context.Login</MudTd>
        <MudTd DataLabel="Pricing Level">@context.PricingLevel</MudTd>
        <MudTd DataLabel="Capacity">
            <MudProgressLinear Color="Color.Primary" Value="@context.RecordCapacity.GetStorageUsedPercentage()" />
        </MudTd>
        <MudTd DataLabel="Action">
            <MudMenu Label="Action" Variant="Variant.Text">
                <MudMenuItem Label="Edit" Href=@($"Admin/EditUser/{context.UserId}") />
                <MudMenuItem Label="Remove" OnClick="@(() => RemoveUser(context.UserId))" />
            </MudMenu>
        </MudTd>
    </RowTemplate>
    <PagerContent>
        @if (Table is not null && _pagesCount > 1)
        {
            <MudPagination SelectedChanged="PageChanged" Count="@_pagesCount" Selected="@SelectedPage" Class="pa-4" />
        }
    </PagerContent>
</MudTable>